# **Kubernetes Application Deployment with AWS CDK and GitHub Actions**

This repository provides an end-to-end Infrastructure-as-Code (IaC) deployment for a Kubernetes environment, configured to deploy the following key components:

- **Flask Application**: A simple web application.
- **MongoDB**: For data persistence.
- **Prometheus**: For monitoring and scraping system metrics.
- **Grafana**: For visualizing metrics and analytics.

The infrastructure is deployed using **AWS CloudFormation**, which is automatically generated by **Python AWS CDK**. The deployment process is fully automated using **GitHub Actions**, and the Kubernetes pods for each service are provisioned on **EC2 instances** acting as a Kubernetes **Master** and **Worker**.

## **Project Architecture**

The project consists of three main AWS CDK stacks:

1. **VpcStack**  
   - Creates a custom **VPC** to host the Kubernetes master and worker nodes.
   
2. **KubernetesMasterStack**  
   - Provisions the **Kubernetes Master Server** on an EC2 instance.
   
3. **KubernetesWorkerStack**  
   - Provisions the **Kubernetes Worker Server** on a separate EC2 instance.

### **Infrastructure Summary**

- The **VPC** is shared between the master and worker stacks.
- Two EC2 instances are created: one for the **Master** node and one for the **Worker** node.
- **Node Exporter** is installed on the master node to expose system metrics, which are scraped by Prometheus.

## **GitHub Actions Pipeline**

The deployment pipeline leverages **GitHub Actions** to automate the provisioning of infrastructure and application deployments. The pipeline performs several tasks:

- **Replace Variables**: Dynamically replaces sensitive variables within the Kubernetes and CDK configuration files.
- **Provision EC2 Instances**: Deploys the master and worker servers.
- **Configure Kubernetes**: Applies configuration files for Flask, MongoDB, Prometheus, and Grafana services.
- **Set Up Prometheus Scraping**: Configures Prometheus to scrape metrics from **Node Exporter** on port 9100.

### **GitHub Secrets Configuration**

The pipeline requires the following secrets to be configured in the GitHub repository:

| Secret                | Description                         |
|-----------------------|-------------------------------------|
| `AWS_ACCESS_KEY_ID`    | AWS Access Key for deployment.      |
| `AWS_ACCOUNT_ID`       | AWS Account ID.                    |
| `AWS_SECRET_ACCESS_KEY`| AWS Secret Key for deployment.      |
| `GRAFANA_ADMIN_PASSWORD`| Admin password for Grafana.        |
| `SERVER_SSH_KEY`       | SSH Key to access EC2 instances.    |
| `SERVER_USER`          | Username for the server access.     |

## **Node Exporter & Prometheus Integration**

- **Node Exporter** is installed on the Kubernetes master node to expose Linux system metrics such as CPU, memory, and disk usage.
- **Prometheus** is configured to scrape metrics from **Node Exporter** on port `9100`.
- The metrics are later visualized via **Grafana**.

### **Grafana Configuration**

- Grafana is used to visualize data scraped by Prometheus.
- We import a pre-built **Grafana Community Dashboard** to avoid manual configuration and display the system metrics.

## **Accessing the Services**

Once deployed, you can access the services as follows:

- **Flask Application**: Accessible via its NodePort on the Kubernetes cluster.
- **MongoDB**: Running as a database backend in the cluster.
- **Prometheus**: Available on port `9090`.
- **Grafana**: Accessible on port `3000`, where you can view the system metrics collected by Node Exporter via Prometheus.

## **How It Works**

1. **AWS CDK for IaC**:
   - The **Python AWS CDK** is used to define the infrastructure, generating CloudFormation templates to deploy the EC2 instances and configure the Kubernetes environment.

2. **Kubernetes Deployment**:
   - The repository contains Kubernetes deployment manifests for the Flask application, MongoDB, Prometheus, and Grafana.
   
3. **Automated CI/CD with GitHub Actions**:
   - A GitHub Actions pipeline automates the deployment process, from provisioning infrastructure to deploying and configuring the application and monitoring services.

## **Setup and Deployment**

1. **Install AWS CDK**:
   - Ensure you have **AWS CDK** installed locally to deploy the stacks:
     ```bash
     npm install -g aws-cdk
     ```
   
2. **Deploy the Stacks Locally**:
   - Deploy the VPC, Master, and Worker stacks using the AWS CDK:
     ```bash
     cdk deploy VpcStack
     cdk deploy KubernetesMasterStack
     cdk deploy KubernetesWorkerStack
     ```

3. **Configure Kubernetes**:
   - Use the provided setup scripts to apply the Kubernetes configuration files for the Flask app, MongoDB, Prometheus, and Grafana. These scripts are located in their respective application folders in folder pods_assets:
     ```bash
     # Flask
     bash setup_flask_kubernetes.sh

     # MongoDB
     bash setup_mongo_deployment.sh

     # Prometheus
     bash setup_prometheus.sh

     # Grafana
     bash setup_grafana.sh
     ```

4. **Monitor Metrics in Grafana**:
   - Once the services are running, configure a new **Prometheus data source** in Grafana and import the desired dashboard from the Grafana Community.

## **Conclusion**

This project demonstrates how to deploy a robust Kubernetes environment on AWS, complete with monitoring and visualization tools, using **AWS CDK** and **GitHub Actions**. The integration of Prometheus and Grafana ensures that the deployed infrastructure is fully monitored, allowing for real-time insights into system performance.
